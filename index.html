<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Прототип сцены — Мировое турне</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: Arial, sans-serif; }
    #overlay {
      position: absolute; left: 12px; top: 12px;
      background: rgba(255,255,255,0.85); padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-width: 320px;
    }
    #infoBox { display: none; margin-top: 8px; padding: 8px; background: #fffbe0; border-radius: 6px; }
    #compass { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
    .btn { padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; background: #f6f6f6; cursor: pointer; }
    #pickupCounter { margin-top: 8px; font-weight: 600; }
    #instructions {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.75); color: #fff; padding: 18px; border-radius: 10px; text-align: center;
    }
    #hud {
      position: absolute; right: 12px; top: 12px; color: #222; background: rgba(255,255,255,0.9);
      padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .portal-glow { filter: drop-shadow(0 0 8px rgba(60,160,255,0.8)); }
  </style>
</head>
<body>
  <div id="overlay">
    <div id="locationName" style="font-weight: 700; font-size: 16px;">Локация: Париж — Эйфелева башня</div>
    <div style="font-size: 13px; color: #333; margin-top: 6px;">
      Навигация: WASD — движение, мышь — смотреть. Клик в сцену для активации управления.
    </div>
    <div id="infoBox"></div>
    <div id="pickupCounter">Сувениры: 0</div>
    <div id="compass">
      <button class="btn" data-target="paris">Париж (Эйфель)</button>
      <button class="btn" data-target="ny">Нью-Йорк (Таймс-сквер)</button>
      <button class="btn" data-target="tokyo">Токио (Сибуя)</button>
    </div>
  </div>

  <div id="hud">Подойдите к <b>i</b> чтобы увидеть инфо; к порталу — чтобы перейти.</div>

  <div id="instructions">
    Нажмите любую клавишу или кликните внутри сцены, чтобы начать (WASD — двигаться).<br><br>
    Кликните чтобы начать.
  </div>

  <script type="module">
    import * as THREE from 'https://esm.sh/three@0.167.0';
    import { PointerLockControls } from 'https://esm.sh/three@0.167.0/examples/jsm/controls/PointerLockControls.js';

    // Проверка поддержки WebGL
    if (!window.WebGLRenderingContext) {
      document.body.innerHTML = '<p>Ваш браузер не поддерживает WebGL. Пожалуйста, используйте современный браузер.</p>';
      throw new Error('WebGL not supported');
    }

    // Настройка рендера
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Камера
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 8);

    // Управление
    const controls = new PointerLockControls(camera, renderer.domElement);
    const instructions = document.getElementById('instructions');
    instructions.addEventListener('click', () => controls.lock());
    controls.addEventListener('lock', () => instructions.style.display = 'none');
    controls.addEventListener('unlock', () => instructions.style.display = 'block');

    // Движение
    const move = { forward: false, back: false, left: false, right: false };
    let velocity = new THREE.Vector3();
    let direction = new THREE.Vector3();

    document.addEventListener('keydown', (e) => {
      switch (e.code) {
        case 'KeyW': move.forward = true; break;
        case 'KeyS': move.back = true; break;
        case 'KeyA': move.left = true; break;
        case 'KeyD': move.right = true; break;
      }
      if (!audioContext) startAmbientTone();
    });

    document.addEventListener('keyup', (e) => {
      switch (e.code) {
        case 'KeyW': move.forward = false; break;
        case 'KeyS': move.back = false; break;
        case 'KeyA': move.left = false; break;
        case 'KeyD': move.right = false; break;
      }
    });

    // Аудио
    let audioContext = null;
    let ambientSource = null;
    let ambientPlaying = false;

    function startAmbientTone(frequency = 220) {
      if (ambientPlaying) return;
      try {
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') {
          audioContext.resume().then(() => {
            ambientSource = audioContext.createOscillator();
            const gain = audioContext.createGain();
            ambientSource.type = 'sine';
            ambientSource.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gain.gain.setValueAtTime(0.02, audioContext.currentTime);
            ambientSource.connect(gain);
            gain.connect(audioContext.destination);
            ambientSource.start();
            ambientPlaying = true;
          });
        }
      } catch (e) {
        console.warn('Не удалось запустить аудио:', e);
      }
    }

    function stopAmbientTone() {
      if (!ambientPlaying) return;
      if (ambientSource) {
        ambientSource.stop();
        ambientSource.disconnect();
        ambientSource = null;
        ambientPlaying = false;
      }
    }

    // Текстуры
    function createTexture(type) {
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 512;
      const ctx = canvas.getContext('2d');
      if (type === 'cobblestone') {
        ctx.fillStyle = '#888';
        ctx.fillRect(0, 0, 512, 512);
        for (let i = 0; i < 20; i++) {
          ctx.fillStyle = `rgba(100,100,100,${Math.random() * 0.5 + 0.5})`;
          ctx.fillRect(
            Math.random() * 512,
            Math.random() * 512,
            50 + Math.random() * 50,
            20 + Math.random() * 30
          );
        }
      } else if (type === 'asphalt') {
        ctx.fillStyle = '#333';
        ctx.fillRect(0, 0, 512, 512);
        for (let i = 0; i < 50; i++) {
          ctx.fillStyle = '#555';
          ctx.fillRect(
            Math.random() * 512,
            Math.random() * 512,
            10 + Math.random() * 20,
            10 + Math.random() * 20
          );
        }
      }
      const tex = new THREE.CanvasTexture(canvas);
      tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
      tex.repeat.set(4, 4);
      return tex;
    }

    // Сцены
    const scenes = {};
    let currentScene = null;

    // Париж (Эйфелева башня)
    function createParisScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xbfeaff);

      // Освещение
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);

      // Пол (брусчатка)
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('cobblestone') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);

      // Эйфелева башня (улучшенная модель из примитивов)
      const towerGroup = new THREE.Group();
      const baseMat = new THREE.MeshStandardMaterial({ color: 0x7a7a7a, metalness: 0.6, roughness: 0.4 });

      const base = new THREE.CylinderGeometry(2.2, 2.8, 0.8, 24);
      const baseMesh = new THREE.Mesh(base, baseMat);
      baseMesh.castShadow = true;
      towerGroup.add(baseMesh);

      for (let i = 0; i < 4; i++) {
        const pillar = new THREE.CylinderGeometry(0.12, 0.12, 6, 8);
        const pMesh = new THREE.Mesh(pillar, baseMat);
        const angle = i * Math.PI / 2;
        const r = 1.4;
        pMesh.position.set(Math.cos(angle) * r, 3, Math.sin(angle) * r);
        pMesh.castShadow = true;
        towerGroup.add(pMesh);
      }

      const platform = new THREE.CylinderGeometry(1.3, 1.3, 0.3, 20);
      const platformMesh = new THREE.Mesh(platform, baseMat);
      platformMesh.position.y = 3;
      platformMesh.castShadow = true;
      towerGroup.add(platformMesh);

      const topCone = new THREE.ConeGeometry(0.4, 2.2, 12);
      const topMesh = new THREE.Mesh(topCone, baseMat);
      topMesh.position.set(0, 6.2, 0);
      topMesh.castShadow = true;
      towerGroup.add(topMesh);

      // Добавляем решётчатую структуру (имитация)
      for (let i = 0; i < 8; i++) {
        const bar = new THREE.CylinderGeometry(0.05, 0.05, 3, 8);
        const barMesh = new THREE.Mesh(bar, baseMat);
        barMesh.position.set(
          Math.cos(i * Math.PI / 4) * 1.0,
          1.5,
          Math.sin(i * Math.PI / 4) * 1.0
        );
        barMesh.rotation.z = Math.PI / 4;
        barMesh.castShadow = true;
        towerGroup.add(barMesh);
      }

      towerGroup.position.set(0, 0.4, -2);
      scene.add(towerGroup);

      // Инфо-иконка
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);

      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);

      // Сувенир
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);

      // Скамейка
      const bench = new THREE.Mesh(
        new THREE.BoxGeometry(1.6, 0.12, 0.3),
        new THREE.MeshStandardMaterial({ color: 0x8b5a3c })
      );
      bench.position.set(-2.2, 0.12, -0.8);
      bench.receiveShadow = true;
      scene.add(bench);

      // Портал
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);

      // Небо
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0xbfeaff, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);

      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Эйфелева башня</b><br>Икона Парижа, построена в 1889 году. Подойдите к порталу или соберите сувенир.'
      };
    }

    // Нью-Йорк (Таймс-сквер)
    function createNYScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1c2526);

      // Освещение
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);

      // Пол (асфальт)
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('asphalt') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);

      // Билборды и здания
      const billboardMat = new THREE.MeshStandardMaterial({ color: 0xff5555, emissive: 0xaa3333, emissiveIntensity: 0.5 });
      for (let i = 0; i < 3; i++) {
        const billboard = new THREE.Mesh(
          new THREE.BoxGeometry(4, 2, 0.2),
          billboardMat
        );
        billboard.position.set(-5 + i * 5, 3, -10);
        billboard.castShadow = true;
        scene.add(billboard);
      }

      const buildingMat = new THREE.MeshStandardMaterial({ color: 0x555555, metalness: 0.2, roughness: 0.8 });
      for (let i = 0; i < 2; i++) {
        const building = new THREE.Mesh(
          new THREE.BoxGeometry(8, 10 + i * 5, 4),
          buildingMat
        );
        building.position.set(-8 + i * 16, 5 + i * 2.5, -12);
        building.castShadow = true;
        scene.add(building);
      }

      // Инфо-иконка
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);

      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);

      // Сувенир
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);

      // Портал
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);

      // Небо
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0x1c2526, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);

      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Таймс-сквер</b><br>Яркое сердце Нью-Йорка. Соберите сувенир и перейдите к следующей локации.'
      };
    }

    // Токио (перекрёсток Сибуя)
    function createTokyoScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x2a2a3a);

      // Освещение
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);

      // Пол (асфальт с разметкой)
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('asphalt') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);

      // Разметка перекрёстка
      const stripeMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
      for (let i = -5; i <= 5; i += 2) {
        const stripe = new THREE.Mesh(
          new THREE.BoxGeometry(10, 0.01, 0.5),
          stripeMat
        );
        stripe.position.set(i, 0.02, 0);
        stripe.receiveShadow = true;
        scene.add(stripe);
      }

      // Здания
      const buildingMat = new THREE.MeshStandardMaterial({ color: 0x666666, metalness: 0.2, roughness: 0.8 });
      for (let i = 0; i < 3; i++) {
        const building = new THREE.Mesh(
          new THREE.BoxGeometry(6, 8 + i * 3, 4),
          buildingMat
        );
        building.position.set(-10 + i * 10, 4 + i * 1.5, -10);
        building.castShadow = true;
        scene.add(building);
      }

      // Вывеска
      const sign = new THREE.Mesh(
        new THREE.BoxGeometry(3, 1.5, 0.2),
        new THREE.MeshStandardMaterial({ color: 0x00ffcc, emissive: 0x00aa88, emissiveIntensity: 0.5 })
      );
      sign.position.set(0, 3, -8);
      sign.castShadow = true;
      scene.add(sign);

      // Инфо-иконка
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);

      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);

      // Сувенир
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);

      // Портал
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);

      // Небо
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0x2a2a3a, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);

      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Перекрёсток Сибуя</b><br>Знаменитый перекрёсток Токио. Соберите сувенир и перейдите дальше.'
      };
    }

    // Инициализация сцен
    scenes.paris = createParisScene();
    scenes.ny = createNYScene();
    scenes.tokyo = createTokyoScene();
    currentScene = scenes.paris;
    let souvenirPicked = false;
    let picks = 0;

    // UI
    const infoBox = document.getElementById('infoBox');
    const counterEl = document.getElementById('pickupCounter');
    const locationName = document.getElementById('locationName');

    function showInfo(text) {
      infoBox.style.display = 'block';
      infoBox.innerHTML = text;
    }

    function hideInfo() {
      infoBox.style.display = 'none';
      infoBox.innerHTML = '';
    }

    function updateCounter(n) {
      counterEl.textContent = `Сувениры: ${n}`;
    }

    // Переключение сцен
    function switchScene(target) {
      stopAmbientTone();
      currentScene = scenes[target];
      souvenirPicked = false;
      camera.position.set(0, 1.6, 8);
      locationName.textContent = {
        paris: 'Локация: Париж — Эйфелева башня',
        ny: 'Локация: Нью-Йорк — Таймс-сквер',
        tokyo: 'Локация: Токио — Перекрёсток Сибуя'
      }[target];
      startAmbientTone({
        paris: 220,
        ny: 260,
        tokyo: 300
      }[target]);
    }

    // Телепортация
    document.querySelectorAll('#compass .btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchScene(btn.dataset.target);
      });
    });

    // Raycaster
    const raycaster = new THREE.Raycaster();
    window.addEventListener('click', (ev) => {
      if (!controls.isLocked) return;
      raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
      const intersects = raycaster.intersectObjects([currentScene.portal, currentScene.souvenir, currentScene.infoMesh, currentScene.sprite], true);
      if (intersects.length > 0) {
        const obj = intersects[0].object;
        if (obj.name === 'portal') {
          switchScene(Object.keys(scenes)[(Object.keys(scenes).indexOf(currentScene === scenes.paris ? 'paris' : currentScene === scenes.ny ? 'ny' : 'tokyo') + 1) % 3]);
        } else if (obj.name === 'souvenir' && !souvenirPicked) {
          currentScene.scene.remove(currentScene.souvenir);
          souvenirPicked = true;
          picks++;
          updateCounter(picks);
        } else if (obj === currentScene.infoMesh || obj === currentScene.sprite) {
          showInfo(currentScene.infoText);
        }
      }
      if (audioContext && audioContext.state === 'suspended') audioContext.resume();
    });

    // Анимация
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const delta = Math.min(0.1, clock.getDelta());

      // Движение
      velocity.x -= velocity.x * 10.0 * delta;
      velocity.z -= velocity.z * 10.0 * delta;
      direction.z = Number(move.forward) - Number(move.back);
      direction.x = Number(move.right) - Number(move.left);
      direction.normalize();
      const speed = 5.0;
      if (move.forward || move.back) velocity.z -= direction.z * speed * delta;
      if (move.left || move.right) velocity.x -= direction.x * speed * delta;
      controls.moveRight(-velocity.x * delta);
      controls.moveForward(-velocity.z * delta);

      // Ограничение высоты
      const pos = controls.getObject().position;
      if (pos.y < 1.6) pos.y = 1.6;

      // Инфо-иконка
      const dInfo = pos.distanceTo(currentScene.infoPos);
      if (dInfo < 2.0) {
        showInfo(currentScene.infoText);
      } else {
        hideInfo();
      }

      // Аудио-триггер
      if (pos.distanceTo(currentScene.audioTriggerPos) < currentScene.audioTriggerRadius) {
        startAmbientTone();
      } else {
        stopAmbientTone();
      }

      // Портал
      const t = performance.now() * 0.002;
      currentScene.portal.material.emissiveIntensity = 0.6 + Math.sin(t) * 0.4;
      currentScene.portal.rotation.y += 0.01;

      renderer.render(currentScene.scene, camera);
    }
    animate();

    // Обработка изменения размера
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Проверка направления взгляда
    function checkCenterLook() {
      if (!controls.isLocked) {
        setTimeout(checkCenterLook, 100);
        return;
      }
      raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
      const hits = raycaster.intersectObject(currentScene.portal);
      const hud = document.getElementById('hud');
      if (hits.length) {
        hud.innerHTML = 'Портал — нажмите мышь, чтобы активировать переход.';
      } else {
        hud.innerHTML = 'Подойдите к <b>i</b> чтобы увидеть инфо; к порталу — чтобы перейти.';
      }
      setTimeout(checkCenterLook, 100);
    }
    checkCenterLook();
  </script>
</body>
</html>
