<html>
  <head>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  </head>
  <body>
    <a-scene background="color: #87CEEB">
      
      <a-assets>
        <a-asset-item id="eiffel-model" src="models/eiffel_tower.glb"></a-asset-item>
        <a-asset-item id="monument-model" src="models/rhinoceros_in_orsay_museum_paris.glb"></a-asset-item>
        <a-asset-item id="bush-model" src="models/stylized_tree.glb"></a-asset-item>
        <a-asset-item id="building1" src="models/medieval_house.glb"></a-asset-item>
        <a-asset-item id="building2" src="models/medieval_house.glb"></a-asset-item>
        <a-asset-item id="building3" src="models/medieval_house.glb"></a-asset-item>
      </a-assets>
      <a-entity id="ambientLight" light="type: ambient; intensity: 0.6; color: #fff"></a-entity>
      <a-entity id="pointLight" light="type: point; intensity: 1.2; distance: 50; color: #fff" position="0 10 10"></a-entity>
      <a-entity id="camera" camera look-controls position="0 1.6 5" reset-on-collision="with: .collision">
        <a-entity cursor="fuse: true; fuseTimeout: 800"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                  material="color: cyan; shader: flat"
                  position="0 0 -1">
        </a-entity>
      </a-entity>
      <a-entity id="paris" visible="true">
        <a-plane rotation="-90 0 0" width="60" height="60" color="#0a0" position="0 0 0"></a-plane>
        <a-plane rotation="-90 0 0" width="5" height="40" color="#555" position="0 0.01 -10"></a-plane>
        <a-image src="models/51b2f4f3bf135718f93794f1411cbba6.jpg" position="-30 10 0" rotation="0 90 0" width="60" height="25"></a-image>
        <a-image src="models/51b2f4f3bf135718f93794f1411cbba6.jpg" position="30 10 0" rotation="0 -90 0" width="60" height="25"></a-image>
        <a-image src="models/51b2f4f3bf135718f93794f1411cbba6.jpg" position="0 10 -30" rotation="0 0 0" width="60" height="25"></a-image>
        <a-image src="models/51b2f4f3bf135718f93794f1411cbba6.jpg" position="0 10 30" rotation="0 180 0" width="60" height="25"></a-image>
        <a-gltf-model src="#bush-model" position="-5 0 -8" scale="15 15 15"></a-gltf-model>
        <a-gltf-model src="#bush-model" position="5 0 -12" scale="15 15 15"></a-gltf-model>
        <a-entity position="-12 0 0">
          <a-gltf-model src="#bush-model" position="0 0 -2" scale="15 15 15"></a-gltf-model>
          <a-gltf-model src="#bush-model" position="0 0 2" scale="15 15 15"></a-gltf-model>
          <a-gltf-model src="#bush-model" position="0 0 6" scale="15 15 15"></a-gltf-model>
          <a-gltf-model src="#bush-model" position="0 0 10" scale="15 15 15"></a-gltf-model>
          <a-gltf-model src="#bush-model" position="0 0 14" scale="15 15 15"></a-gltf-model>
        </a-entity>

        <a-gltf-model src="#building1" position="-24 0 0" scale="0.3 0.3 0.3" rotation="0 0 0" class="collision"></a-gltf-model>
        <a-gltf-model src="#building2" position="-20 0 19" scale="0.3 0.3 0.3" rotation="0 90 0" class="collision"></a-gltf-model>
        <a-gltf-model src="#building3" position="-23 0 -25" scale="0.3 0.3 0.3" rotation="0 90 0" class="collision"></a-gltf-model>

        <a-entity position="12 0 0">
          <a-gltf-model src="#bush-model" position="0 0 -2" scale="15 15 15"></a-gltf-model>
          <a-gltf-model src="#bush-model" position="0 0 2" scale="15 15 15"></a-gltf-model>
          <a-gltf-model src="#bush-model" position="0 0 6" scale="15 15 15"></a-gltf-model>
          <a-gltf-model src="#bush-model" position="0 0 10" scale="15 15 15"></a-gltf-model>
          <a-gltf-model src="#bush-model" position="0 0 14" scale="15 15 15"></a-gltf-model>
        </a-entity>
        <a-gltf-model src="#building2" position="23 0 -15" scale="0.3 0.3 0.3" rotation="0 90 0" class="collision"></a-gltf-model>
        <a-gltf-model src="#building3" position="25 0 5" scale="0.3 0.3 0.3" rotation="0 90 0" class="collision"></a-gltf-model>
        <a-gltf-model src="#building1" position="25 0 17" scale="0.3 0.3 0.3" class="collision"></a-gltf-model>

        <a-gltf-model id="eiffel" src="#eiffel-model" position="0 0 -6" scale="0.5 0.5 0.5" class="clickable"></a-gltf-model>
        <a-gltf-model src="#monument-model" position="0 0 15" scale="0.2 0.2 0.2" rotation="0 180 0"></a-gltf-model>
        <a-text value="Париж" position="-1 4 -6" color="black" width="8"></a-text>

        <a-plane id="btnDayNight" position="-0.7 1.5 4" width="0.4" height="0.2" color="#3498db"
                 text="value: День/Ночь; align: center; color: white"></a-plane>
        <a-plane id="btnLight" position="0.7 1.5 4" width="0.4" height="0.2" color="#f39c12"
                 text="value: Подсветка; align: center; color: white"></a-plane>

        <a-ring id="portalToTokyo" position="4 2 -5" radius-inner="1" radius-outer="1.3"
                material="color: #00f; opacity: 0.6; side: double"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"></a-ring>
        <a-entity position="4 2 -5">
          <a-torus radius="1.5" radius-tubular="0.05"
                   material="color: #0ff; emissive: #0ff; opacity: 0.7"
                   animation="property: rotation; to: 360 0 0; loop: true; dur: 6000"></a-torus>
        </a-entity>
      </a-entity>

      <a-entity id="tokyo" visible="false">
        <a-plane rotation="-90 0 0" width="30" height="30" color="#111"></a-plane>
        <a-plane rotation="-90 0 0" width="10" height="30" color="#333" position="0 0 -10"></a-plane>
        <a-plane rotation="-90 0 0" width="30" height="10" color="#333" position="0 0 -10"></a-plane>
        <a-gltf-model src="#bush-model" position="-4 0 -8" scale="1.3 1.3 1.3"></a-gltf-model>
        <a-box position="-3 2 -6" depth="2" height="4" width="2" material="color: #ff00ff; emissive: #ff00ff; opacity: 0.9" class="collision"></a-box>
        <a-box position="3 3 -6" depth="2" height="6" width="2" material="color: #00ffff; emissive: #00ffff; opacity: 0.9" class="collision"></a-box>
        <a-box position="0 1.5 -4" depth="2" height="3" width="2" material="color: #ffff00; emissive: #ffff00; opacity: 0.8" class="collision"></a-box>
        <a-text value="Токио" position="-1 5 -6" color="white" width="8"></a-text>
        <a-ring id="portalToParis" position="0 2 -3" radius-inner="1" radius-outer="1.3"
                material="color: #f00; opacity: 0.6; side: double"
                animation="property: rotation; to: 0 -360 0; loop: true; dur: 4000"></a-ring>
        <a-entity position="0 2 -3">
          <a-torus radius="1.5" radius-tubular="0.05"
                   material="color: #ff0; emissive: #ff0; opacity: 0.7"
                   animation="property: rotation; to: -360 0 0; loop: true; dur: 6000"></a-torus>
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      AFRAME.registerComponent('reset-on-collision', {
        schema: {
          with: {type: 'selectorAll', default: '.collision'}
        },
        init: function () {
          this.initialPosition = this.el.getAttribute('position').clone();
          this.colliders = document.querySelectorAll(this.data.with);
          this.el.sceneEl.addEventListener('loaded', () => {
            this.camera = this.el.querySelector('a-camera') || this.el;
          });
        },
        tick: function () {
          if (!this.camera) return;
          const cameraPos = this.camera.getAttribute('position');
          const threshold = 1.5; // Distance threshold for collision detection
          
          this.colliders.forEach(collider => {
            const colliderPos = collider.getAttribute('position');
            const distance = cameraPos.distanceTo(colliderPos);
            
            if (distance < threshold) {
              this.camera.setAttribute('position', this.initialPosition);
            }
          });
        }
      });

      const paris = document.querySelector('#paris');
      const tokyo = document.querySelector('#tokyo');
      const portalToTokyo = document.querySelector('#portalToTokyo');
      const portalToParis = document.querySelector('#portalToParis');
      const eiffel = document.querySelector('#eiffel');
      const btnDayNight = document.querySelector('#btnDayNight');
      const btnLight = document.querySelector('#btnLight');
      const scene = document.querySelector('a-scene');
      const ambientLight = document.querySelector('#ambientLight');
      const pointLight = document.querySelector('#pointLight');

      let isRotating = false;
      let isNight = false;
      let isLightOn = false;

      eiffel.addEventListener('click', () => {
        if (!isRotating) {
          eiffel.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear');
          isRotating = true;
        } else {
          eiffel.removeAttribute('animation');
          isRotating = false;
        }
      });

      btnDayNight.addEventListener('click', () => {
        isNight = !isNight;
        if (isNight) {
          scene.setAttribute('background', 'color: #001133');
          ambientLight.setAttribute('light', 'intensity: 0.2; color: #99ccff');
          pointLight.setAttribute('light', 'intensity: 0.8; color: #ffffff');
        } else {
          scene.setAttribute('background', 'color: #87CEEB');
          ambientLight.setAttribute('light', 'intensity: 0.6; color: #fff');
          pointLight.setAttribute('light', 'intensity: 1.2; color: #fff');
        }
      });

      const eiffelLight = document.createElement('a-entity');
      eiffelLight.setAttribute('light', 'type: point; color: #f1c40f; intensity: 2; distance: 10');
      eiffelLight.setAttribute('position', '0 5 -6');
      eiffelLight.setAttribute('visible', 'false');
      paris.appendChild(eiffelLight);
      btnLight.addEventListener('click', () => {
        isLightOn = !isLightOn;
        eiffelLight.setAttribute('visible', isLightOn);
      });
      portalToTokyo.addEventListener('click', () => {
        paris.setAttribute('visible', 'false');
        tokyo.setAttribute('visible', 'true');
      });
      portalToParis.addEventListener('click', () => {
        tokyo.setAttribute('visible', 'false');
        paris.setAttribute('visible', 'true');
      });

      const bushes = document.querySelectorAll('a-gltf-model[src="#bush-model"]');
      bushes.forEach(bush => {
        let isOrange = false;
        bush.addEventListener('click', () => {
          const mesh = bush.getObject3D('mesh');
          if (!mesh) return;
          mesh.traverse(node => {
            if (node.isMesh && node.material && (
              node.name.toLowerCase().includes('leaf') ||
              node.name.toLowerCase().includes('leaves') ||
              node.name.toLowerCase().includes('foliage') ||
              node.name.toLowerCase().includes('tree_top')
            )) {
              node.material.color.set(isOrange ? '#228B22' : '#FFA500');
            }
          });
          isOrange = !isOrange;
        });
      });
    </script>
  </body>
</html>
