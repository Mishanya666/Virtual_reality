<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Прототип сцены — Мировое турне</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: Arial, sans-serif; }
    #overlay {
      position: absolute; left: 12px; top: 12px;
      background: rgba(255,255,255,0.85); padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-width: 320px;
    }
    #infoBox { display: none; margin-top: 8px; padding: 8px; background: #fffbe0; border-radius: 6px; }
    #compass { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
    .btn { padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; background: #f6f6f6; cursor: pointer; }
    #pickupCounter { margin-top: 8px; font-weight: 600; }
    #instructions {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.75); color: #fff; padding: 18px; border-radius: 10px; text-align: center;
    }
    #hud {
      position: absolute; right: 12px; top: 12px; color: #222; background: rgba(255,255,255,0.9);
      padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .portal-glow { filter: drop-shadow(0 0 8px rgba(60,160,255,0.8)); }
  </style>
</head>
<body>
  <div id="overlay">
    <div id="locationName" style="font-weight: 700; font-size: 16px;">Локация: Париж — Эйфелева башня</div>
    <div style="font-size: 13px; color: #333; margin-top: 6px;">
      Навигация: WASD — движение, Shift — бег, Пробел — прыжок, мышь — смотреть. Клик в сцену для активации управления.
    </div>
    <div id="infoBox"></div>
    <div id="pickupCounter">Сувениры: 0</div>
    <div id="compass">
      <button class="btn" data-target="paris">Париж (Эйфель)</button>
      <button class="btn" data-target="louvre">Лувр</button>
      <button class="btn" data-target="ny">Нью-Йорк (Таймс-сквер)</button>
      <button class="btn" data-target="centralpark">Центральный парк Нью-Йорка</button>
      <button class="btn" data-target="tokyo">Токио (Сибуя)</button>
      <button class="btn" data-target="sensoji">Храм Сензодзи</button>
      <button class="btn" data-target="pyramids">Пирамиды Гизы</button>
      <button class="btn" data-target="sphinx">Сфинкс</button>
      <button class="btn" data-target="colosseum">Колизей</button>
      <button class="btn" data-target="trevi">Фонтан Треви</button>
    </div>
  </div>

  <div id="hud">Подойдите к <b>i</b> чтобы увидеть инфо; к порталу — чтобы перейти.</div>

  <div id="instructions">
    Нажмите любую клавишу или кликните внутри сцены, чтобы начать (WASD — двигаться, Shift — бег, Пробел — прыжок).<br><br>
    Кликните чтобы начать.
  </div>

  <script type="module">
    import * as THREE from 'https://esm.sh/three@0.167.0';
    import { PointerLockControls } from 'https://esm.sh/three@0.167.0/examples/jsm/controls/PointerLockControls.js';

    // Проверка поддержки WebGL
    if (!window.WebGLRenderingContext) {
      document.body.innerHTML = '<p>Ваш браузер не поддерживает WebGL. Пожалуйста, используйте современный браузер.</p>';
      throw new Error('WebGL not supported');
    }

    // Настройка рендера
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Камера
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 8);

    // Управление
    const controls = new PointerLockControls(camera, renderer.domElement);
    const instructions = document.getElementById('instructions');
    instructions.addEventListener('click', () => controls.lock());
    controls.addEventListener('lock', () => instructions.style.display = 'none');
    controls.addEventListener('unlock', () => instructions.style.display = 'block');

    // Движение
    const move = { forward: false, back: false, left: false, right: false, jump: false, sprint: false };
    let velocity = new THREE.Vector3();
    let direction = new THREE.Vector3();
    const groundLevel = 1.6; // Уровень земли
    let isGrounded = true; // Флаг, находится ли игрок на земле

    document.addEventListener('keydown', (e) => {
      switch (e.code) {
        case 'KeyW': move.forward = true; break;
        case 'KeyS': move.back = true; break;
        case 'KeyA': move.left = true; break;
        case 'KeyD': move.right = true; break;
        case 'Space':
          if (isGrounded) {
            move.jump = true;
            velocity.y = 5.0; // Начальная скорость прыжка
            isGrounded = false;
          }
          break;
        case 'ShiftLeft': move.sprint = true; break;
      }
      if (!audioContext) startAmbientTone();
    });

    document.addEventListener('keyup', (e) => {
      switch (e.code) {
        case 'KeyW': move.forward = false; break;
        case 'KeyS': move.back = false; break;
        case 'KeyA': move.left = false; break;
        case 'KeyD': move.right = false; break;
        case 'Space': move.jump = false; break;
        case 'ShiftLeft': move.sprint = false; break;
      }
    });

    // Аудио
    let audioContext = null;
    let ambientSource = null;
    let ambientPlaying = false;

    function startAmbientTone(frequency = 220) {
      if (ambientPlaying) return;
      try {
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') {
          audioContext.resume().then(() => {
            ambientSource = audioContext.createOscillator();
            const gain = audioContext.createGain();
            ambientSource.type = 'sine';
            ambientSource.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gain.gain.setValueAtTime(0.02, audioContext.currentTime);
            ambientSource.connect(gain);
            gain.connect(audioContext.destination);
            ambientSource.start();
            ambientPlaying = true;
          });
        }
      } catch (e) {
        console.warn('Не удалось запустить аудио:', e);
      }
    }

    function stopAmbientTone() {
      if (!ambientPlaying) return;
      if (ambientSource) {
        ambientSource.stop();
        ambientSource.disconnect();
        ambientSource = null;
        ambientPlaying = false;
      }
    }

    // Текстуры
    function createTexture(type) {
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 512;
      const ctx = canvas.getContext('2d');
      if (type === 'cobblestone') {
        ctx.fillStyle = '#888';
        ctx.fillRect(0, 0, 512, 512);
        for (let i = 0; i < 20; i++) {
          ctx.fillStyle = `rgba(100,100,100,${Math.random() * 0.5 + 0.5})`;
          ctx.fillRect(
            Math.random() * 512,
            Math.random() * 512,
            50 + Math.random() * 50,
            20 + Math.random() * 30
          );
        }
      } else if (type === 'asphalt') {
        ctx.fillStyle = '#333';
        ctx.fillRect(0, 0, 512, 512);
        for (let i = 0; i < 50; i++) {
          ctx.fillStyle = '#555';
          ctx.fillRect(
            Math.random() * 512,
            Math.random() * 512,
            10 + Math.random() * 20,
            10 + Math.random() * 20
          );
        }
      } else if (type === 'grass') {
        ctx.fillStyle = '#228B22';
        ctx.fillRect(0, 0, 512, 512);
        for (let i = 0; i < 100; i++) {
          ctx.fillStyle = '#006400';
          ctx.fillRect(
            Math.random() * 512,
            Math.random() * 512,
            20 + Math.random() * 40,
            20 + Math.random() * 40
          );
        }
      } else if (type === 'sand') {
        ctx.fillStyle = '#EDC9AF';
        ctx.fillRect(0, 0, 512, 512);
        for (let i = 0; i < 50; i++) {
          ctx.fillStyle = '#D2B48C';
          ctx.fillRect(
            Math.random() * 512,
            Math.random() * 512,
            10 + Math.random() * 20,
            10 + Math.random() * 20
          );
        }
      } else if (type === 'stone') {
        ctx.fillStyle = '#A9A9A9';
        ctx.fillRect(0, 0, 512, 512);
        for (let i = 0; i < 30; i++) {
          ctx.fillStyle = '#808080';
          ctx.fillRect(
            Math.random() * 512,
            Math.random() * 512,
            30 + Math.random() * 60,
            30 + Math.random() * 60
          );
        }
      } else if (type === 'water') {
        ctx.fillStyle = '#4682B4';
        ctx.fillRect(0, 0, 512, 512);
        for (let i = 0; i < 20; i++) {
          ctx.fillStyle = '#87CEEB';
          ctx.fillRect(
            Math.random() * 512,
            Math.random() * 512,
            40 + Math.random() * 80,
            40 + Math.random() * 80
          );
        }
      }
      const tex = new THREE.CanvasTexture(canvas);
      tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
      tex.repeat.set(4, 4);
      return tex;
    }

    // Сцены (без изменений)
    const scenes = {};
    let currentScene = null;

    function createParisScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xbfeaff);
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('cobblestone') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      const towerGroup = new THREE.Group();
      const baseMat = new THREE.MeshStandardMaterial({ color: 0x7a7a7a, metalness: 0.6, roughness: 0.4 });
      const base = new THREE.CylinderGeometry(2.2, 2.8, 0.8, 24);
      const baseMesh = new THREE.Mesh(base, baseMat);
      baseMesh.castShadow = true;
      towerGroup.add(baseMesh);
      for (let i = 0; i < 4; i++) {
        const pillar = new THREE.CylinderGeometry(0.12, 0.12, 6, 8);
        const pMesh = new THREE.Mesh(pillar, baseMat);
        const angle = i * Math.PI / 2;
        const r = 1.4;
        pMesh.position.set(Math.cos(angle) * r, 3, Math.sin(angle) * r);
        pMesh.castShadow = true;
        towerGroup.add(pMesh);
      }
      const platform = new THREE.CylinderGeometry(1.3, 1.3, 0.3, 20);
      const platformMesh = new THREE.Mesh(platform, baseMat);
      platformMesh.position.y = 3;
      platformMesh.castShadow = true;
      towerGroup.add(platformMesh);
      const topCone = new THREE.ConeGeometry(0.4, 2.2, 12);
      const topMesh = new THREE.Mesh(topCone, baseMat);
      topMesh.position.set(0, 6.2, 0);
      topMesh.castShadow = true;
      towerGroup.add(topMesh);
      for (let i = 0; i < 8; i++) {
        const bar = new THREE.CylinderGeometry(0.05, 0.05, 3, 8);
        const barMesh = new THREE.Mesh(bar, baseMat);
        barMesh.position.set(
          Math.cos(i * Math.PI / 4) * 1.0,
          1.5,
          Math.sin(i * Math.PI / 4) * 1.0
        );
        barMesh.rotation.z = Math.PI / 4;
        barMesh.castShadow = true;
        towerGroup.add(barMesh);
      }
      towerGroup.position.set(0, 0.4, -2);
      scene.add(towerGroup);
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);
      const bench = new THREE.Mesh(
        new THREE.BoxGeometry(1.6, 0.12, 0.3),
        new THREE.MeshStandardMaterial({ color: 0x8b5a3c })
      );
      bench.position.set(-2.2, 0.12, -0.8);
      bench.receiveShadow = true;
      scene.add(bench);
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0xbfeaff, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Эйфелева башня</b><br>Икона Парижа, построена в 1889 году. Подойдите к порталу или соберите сувенир.'
      };
    }

    function createLouvreScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xbfeaff);
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('cobblestone') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      const buildingMat = new THREE.MeshStandardMaterial({ color: 0xbebebe, metalness: 0.1, roughness: 0.7 });
      const mainBuilding = new THREE.Mesh(
        new THREE.BoxGeometry(10, 4, 5),
        buildingMat
      );
      mainBuilding.position.set(0, 2, -5);
      mainBuilding.castShadow = true;
      scene.add(mainBuilding);
      const pyramidMat = new THREE.MeshStandardMaterial({ color: 0xadd8e6, transparent: true, opacity: 0.6, metalness: 0.5, roughness: 0.3 });
      const pyramid = new THREE.Mesh(
        new THREE.ConeGeometry(2, 3, 4),
        pyramidMat
      );
      pyramid.position.set(0, 1.5, -2);
      pyramid.castShadow = true;
      scene.add(pyramid);
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0xbfeaff, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Лувр</b><br>Один из крупнейших музеев мира в Париже. Подойдите к порталу или соберите сувенир.'
      };
    }

    function createNYScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1c2526);
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('asphalt') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      const billboardMat = new THREE.MeshStandardMaterial({ color: 0xff5555, emissive: 0xaa3333, emissiveIntensity: 0.5 });
      for (let i = 0; i < 3; i++) {
        const billboard = new THREE.Mesh(
          new THREE.BoxGeometry(4, 2, 0.2),
          billboardMat
        );
        billboard.position.set(-5 + i * 5, 3, -10);
        billboard.castShadow = true;
        scene.add(billboard);
      }
      const buildingMat = new THREE.MeshStandardMaterial({ color: 0x555555, metalness: 0.2, roughness: 0.8 });
      for (let i = 0; i < 2; i++) {
        const building = new THREE.Mesh(
          new THREE.BoxGeometry(8, 10 + i * 5, 4),
          buildingMat
        );
        building.position.set(-8 + i * 16, 5 + i * 2.5, -12);
        building.castShadow = true;
        scene.add(building);
      }
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0x1c2526, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Таймс-сквер</b><br>Яркое сердце Нью-Йорка. Соберите сувенир и перейдите к следующей локации.'
      };
    }

    function createCentralParkScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87ceeb);
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('grass') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      const treeMat = new THREE.MeshStandardMaterial({ color: 0x228b22 });
      for (let i = 0; i < 5; i++) {
        const trunk = new THREE.Mesh(
          new THREE.CylinderGeometry(0.2, 0.3, 2, 8),
          new THREE.MeshStandardMaterial({ color: 0x8b4513 })
        );
        trunk.position.set(-5 + i * 3, 1, -5);
        trunk.castShadow = true;
        scene.add(trunk);
        const foliage = new THREE.Mesh(
          new THREE.ConeGeometry(1.5, 3, 8),
          treeMat
        );
        foliage.position.set(-5 + i * 3, 2.5, -5);
        foliage.castShadow = true;
        scene.add(foliage);
      }
      const lake = new THREE.Mesh(
        new THREE.CircleGeometry(4, 32),
        new THREE.MeshStandardMaterial({ color: 0x4682b4, side: THREE.DoubleSide })
      );
      lake.rotation.x = -Math.PI / 2;
      lake.position.set(0, 0.01, -10);
      lake.receiveShadow = true;
      scene.add(lake);
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0x87ceeb, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Центральный парк Нью-Йорка</b><br>Оазис в сердце города. Соберите сувенир и перейдите дальше.'
      };
    }

    function createTokyoScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x2a2a3a);
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('asphalt') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      const stripeMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
      for (let i = -5; i <= 5; i += 2) {
        const stripe = new THREE.Mesh(
          new THREE.BoxGeometry(10, 0.01, 0.5),
          stripeMat
        );
        stripe.position.set(i, 0.02, 0);
        stripe.receiveShadow = true;
        scene.add(stripe);
      }
      const buildingMat = new THREE.MeshStandardMaterial({ color: 0x666666, metalness: 0.2, roughness: 0.8 });
      for (let i = 0; i < 3; i++) {
        const building = new THREE.Mesh(
          new THREE.BoxGeometry(6, 8 + i * 3, 4),
          buildingMat
        );
        building.position.set(-10 + i * 10, 4 + i * 1.5, -10);
        building.castShadow = true;
        scene.add(building);
      }
      const sign = new THREE.Mesh(
        new THREE.BoxGeometry(3, 1.5, 0.2),
        new THREE.MeshStandardMaterial({ color: 0x00ffcc, emissive: 0x00aa88, emissiveIntensity: 0.5 })
      );
      sign.position.set(0, 3, -8);
      sign.castShadow = true;
      scene.add(sign);
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0x2a2a3a, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Перекрёсток Сибуя</b><br>Знаменитый перекрёсток Токио. Соберите сувенир и перейдите дальше.'
      };
    }

    function createSensojiScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffd700);
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('stone') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      const pagodaMat = new THREE.MeshStandardMaterial({ color: 0xff0000, metalness: 0.1, roughness: 0.5 });
      for (let i = 0; i < 5; i++) {
        const tier = new THREE.Mesh(
          new THREE.BoxGeometry(3 - i * 0.5, 1, 3 - i * 0.5),
          pagodaMat
        );
        tier.position.set(0, i + 0.5, -5);
        tier.castShadow = true;
        scene.add(tier);
      }
      const gate = new THREE.Mesh(
        new THREE.BoxGeometry(4, 4, 0.5),
        new THREE.MeshStandardMaterial({ color: 0xff4500 })
      );
      gate.position.set(0, 2, -10);
      gate.castShadow = true;
      scene.add(gate);
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0xffd700, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Храм Сензодзи</b><br>Древний храм в Токио. Соберите сувенир и перейдите дальше.'
      };
    }

    function createPyramidsScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffdab9);
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('sand') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      const pyramidMat = new THREE.MeshStandardMaterial({ color: 0xcd853f, metalness: 0.1, roughness: 0.8 });
      const pyramid1 = new THREE.Mesh(
        new THREE.ConeGeometry(3, 4, 4),
        pyramidMat
      );
      pyramid1.position.set(0, 2, -5);
      pyramid1.castShadow = true;
      scene.add(pyramid1);
      const pyramid2 = new THREE.Mesh(
        new THREE.ConeGeometry(2.5, 3.5, 4),
        pyramidMat
      );
      pyramid2.position.set(5, 1.75, -10);
      pyramid2.castShadow = true;
      scene.add(pyramid2);
      const pyramid3 = new THREE.Mesh(
        new THREE.ConeGeometry(2, 3, 4),
        pyramidMat
      );
      pyramid3.position.set(-5, 1.5, -10);
      pyramid3.castShadow = true;
      scene.add(pyramid3);
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0xffdab9, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Пирамиды Гизы</b><br>Древние чудеса Египта. Соберите сувенир и перейдите дальше.'
      };
    }

    function createSphinxScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffdab9);
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('sand') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      const sphinxMat = new THREE.MeshStandardMaterial({ color: 0xcd853f, metalness: 0.1, roughness: 0.8 });
      const body = new THREE.Mesh(
        new THREE.BoxGeometry(4, 1.5, 8),
        sphinxMat
      );
      body.position.set(0, 0.75, -5);
      body.castShadow = true;
      scene.add(body);
      const head = new THREE.Mesh(
        new THREE.BoxGeometry(1.5, 1.5, 1.5),
        sphinxMat
      );
      head.position.set(0, 2, -2);
      head.castShadow = true;
      scene.add(head);
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0xffdab9, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Сфинкс</b><br>Загадочный страж пирамид. Соберите сувенир и перейдите дальше.'
      };
    }

    function createColosseumScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xbfeaff);
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('stone') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      const colosseumMat = new THREE.MeshStandardMaterial({ color: 0xa0522d, metalness: 0.1, roughness: 0.8 });
      const outerRing = new THREE.Mesh(
        new THREE.CylinderGeometry(5, 5, 4, 32),
        colosseumMat
      );
      outerRing.position.set(0, 2, -5);
      outerRing.castShadow = true;
      scene.add(outerRing);
      const innerRing = new THREE.Mesh(
        new THREE.CylinderGeometry(4, 4, 3, 32),
        colosseumMat
      );
      innerRing.position.set(0, 1.5, -5);
      innerRing.castShadow = true;
      scene.add(innerRing);
      for (let i = 0; i < 16; i++) {
        const arch = new THREE.Mesh(
          new THREE.BoxGeometry(0.5, 1, 0.5),
          colosseumMat
        );
        const angle = i * Math.PI / 8;
        arch.position.set(Math.cos(angle) * 4.5, 2, Math.sin(angle) * 4.5 - 5);
        arch.castShadow = true;
        scene.add(arch);
      }
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0xbfeaff, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Колизей</b><br>Древний амфитеатр в Риме. Соберите сувенир и перейдите дальше.'
      };
    }

    function createTreviScene() {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xbfeaff);
      const hemi = new THREE.HemisphereLight(0xfff8e6, 0x444455, 0.8);
      scene.add(hemi);
      const sun = new THREE.DirectionalLight(0xffffff, 0.9);
      sun.position.set(5, 10, 7);
      sun.castShadow = true;
      sun.shadow.mapSize.set(512, 512);
      scene.add(sun);
      const groundGeo = new THREE.PlaneGeometry(60, 60);
      const groundMat = new THREE.MeshStandardMaterial({ map: createTexture('stone') });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      const pool = new THREE.Mesh(
        new THREE.CircleGeometry(5, 32),
        new THREE.MeshStandardMaterial({ color: 0x4682b4, side: THREE.DoubleSide })
      );
      pool.rotation.x = -Math.PI / 2;
      pool.position.set(0, 0.01, -5);
      pool.receiveShadow = true;
      scene.add(pool);
      const statueMat = new THREE.MeshStandardMaterial({ color: 0xf5f5f5, metalness: 0.2, roughness: 0.5 });
      for (let i = 0; i < 3; i++) {
        const statue = new THREE.Mesh(
          new THREE.BoxGeometry(1, 3, 1),
          statueMat
        );
        statue.position.set(-2 + i * 2, 1.5, -10);
        statue.castShadow = true;
        scene.add(statue);
      }
      const infoPos = new THREE.Vector3(2.6, 1.2, -1.5);
      const infoGeom = new THREE.SphereGeometry(0.18, 12, 12);
      const infoMat = new THREE.MeshStandardMaterial({ color: 0x2a9df4, emissive: 0x1a6fb2, metalness: 0.2, roughness: 0.6 });
      const infoMesh = new THREE.Mesh(infoGeom, infoMat);
      infoMesh.position.copy(infoPos);
      infoMesh.castShadow = true;
      scene.add(infoMesh);
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 128;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0, 0, 128, 128);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 90px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('i', 64, 70);
      const spriteTex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: spriteTex, transparent: true });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(0.6, 0.6, 1);
      sprite.position.copy(infoPos).add(new THREE.Vector3(0, 0.45, 0));
      scene.add(sprite);
      const souvenir = new THREE.Mesh(
        new THREE.BoxGeometry(0.28, 0.18, 0.28),
        new THREE.MeshStandardMaterial({ color: 0xffcc00 })
      );
      souvenir.position.set(-2.2, 0.16, -0.8);
      souvenir.castShadow = true;
      souvenir.name = 'souvenir';
      scene.add(souvenir);
      const portal = new THREE.Mesh(
        new THREE.TorusGeometry(0.9, 0.14, 16, 60),
        new THREE.MeshStandardMaterial({ color: 0x1980ff, emissive: 0x104f80, metalness: 0.3, roughness: 0.2 })
      );
      portal.position.set(4.8, 1.0, -2);
      portal.castShadow = false;
      portal.name = 'portal';
      scene.add(portal);
      const skyGeo = new THREE.SphereGeometry(200, 32, 15);
      const skyMat = new THREE.MeshBasicMaterial({ color: 0xbfeaff, side: THREE.BackSide });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      return {
        scene,
        infoPos,
        portal,
        souvenir,
        audioTriggerPos: new THREE.Vector3(-0.8, 0.5, 2.6),
        audioTriggerRadius: 3.0,
        portalTriggerPos: portal.position.clone(),
        portalTriggerRadius: 1.4,
        infoMesh,
        sprite,
        infoText: '<b>Фонтан Треви</b><br>Барочный фонтан в Риме. Соберите сувенир и перейдите дальше.'
      };
    }

    // Инициализация сцен
    scenes.paris = createParisScene();
    scenes.louvre = createLouvreScene();
    scenes.ny = createNYScene();
    scenes.centralpark = createCentralParkScene();
    scenes.tokyo = createTokyoScene();
    scenes.sensoji = createSensojiScene();
    scenes.pyramids = createPyramidsScene();
    scenes.sphinx = createSphinxScene();
    scenes.colosseum = createColosseumScene();
    scenes.trevi = createTreviScene();
    currentScene = scenes.paris;
    let souvenirPicked = false;
    let picks = 0;

    // UI
    const infoBox = document.getElementById('infoBox');
    const counterEl = document.getElementById('pickupCounter');
    const locationName = document.getElementById('locationName');

    function showInfo(text) {
      infoBox.style.display = 'block';
      infoBox.innerHTML = text;
    }

    function hideInfo() {
      infoBox.style.display = 'none';
      infoBox.innerHTML = '';
    }

    function updateCounter(n) {
      counterEl.textContent = `Сувениры: ${n}`;
    }

    // Переключение сцен
    function switchScene(target) {
      stopAmbientTone();
      currentScene = scenes[target];
      souvenirPicked = false;
      camera.position.set(0, 1.6, 8);
      velocity.set(0, 0, 0); // Сбрасываем скорость при смене сцены
      isGrounded = true; // Устанавливаем на землю
      locationName.textContent = {
        paris: 'Локация: Париж — Эйфелева башня',
        louvre: 'Локация: Лувр',
        ny: 'Локация: Нью-Йорк — Таймс-сквер',
        centralpark: 'Локация: Центральный парк Нью-Йорка',
        tokyo: 'Локация: Токио — Перекрёсток Сибуя',
        sensoji: 'Локация: Храм Сензодзи',
        pyramids: 'Локация: Пирамиды Гизы',
        sphinx: 'Локация: Сфинкс',
        colosseum: 'Локация: Колизей',
        trevi: 'Локация: Фонтан Треви'
      }[target];
      startAmbientTone({
        paris: 220,
        louvre: 230,
        ny: 260,
        centralpark: 270,
        tokyo: 300,
        sensoji: 310,
        pyramids: 340,
        sphinx: 350,
        colosseum: 380,
        trevi: 390
      }[target]);
    }

    // Телепортация
    document.querySelectorAll('#compass .btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchScene(btn.dataset.target);
      });
    });

    // Raycaster
    const raycaster = new THREE.Raycaster();
    window.addEventListener('click', (ev) => {
      if (!controls.isLocked) return;
      raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
      const intersects = raycaster.intersectObjects([currentScene.portal, currentScene.souvenir, currentScene.infoMesh, currentScene.sprite], true);
      if (intersects.length > 0) {
        const obj = intersects[0].object;
        if (obj.name === 'portal') {
          const keys = Object.keys(scenes);
          const currentIndex = keys.indexOf(targetFromScene(currentScene));
          const nextIndex = (currentIndex + 1) % keys.length;
          switchScene(keys[nextIndex]);
        } else if (obj.name === 'souvenir' && !souvenirPicked) {
          currentScene.scene.remove(currentScene.souvenir);
          souvenirPicked = true;
          picks++;
          updateCounter(picks);
        } else if (obj === currentScene.infoMesh || obj === currentScene.sprite) {
          showInfo(currentScene.infoText);
        }
      }
      if (audioContext && audioContext.state === 'suspended') audioContext.resume();
    });

    function targetFromScene(sceneObj) {
      const keys = Object.keys(scenes);
      for (let key of keys) {
        if (scenes[key] === sceneObj) return key;
      }
      return 'paris';
    }

    // Анимация
    const clock = new THREE.Clock();
    const gravity = -9.8; // Гравитация
    function animate() {
      requestAnimationFrame(animate);
      const delta = Math.min(0.1, clock.getDelta());

      // Движение
      velocity.x -= velocity.x * 10.0 * delta;
      velocity.z -= velocity.z * 10.0 * delta;
      direction.z = Number(move.forward) - Number(move.back);
      direction.x = Number(move.right) - Number(move.left);
      direction.normalize();
      const baseSpeed = 25.0;
      const sprintMultiplier = move.sprint ? 1.5 : 1.0; // Ускорение при беге
      const speed = baseSpeed * sprintMultiplier;
      if (move.forward || move.back) velocity.z -= direction.z * speed * delta;
      if (move.left || move.right) velocity.x -= direction.x * speed * delta;
      controls.moveRight(-velocity.x * delta);
      controls.moveForward(-velocity.z * delta);

      // Прыжки и гравитация
      const pos = controls.getObject().position;
      velocity.y += gravity * delta; // Применяем гравитацию
      pos.y += velocity.y * delta; // Обновляем позицию по Y
      if (pos.y <= groundLevel) {
        pos.y = groundLevel;
        velocity.y = 0;
        isGrounded = true; // Игрок на земле
      }

      // Инфо-иконка
      const dInfo = pos.distanceTo(currentScene.infoPos);
      if (dInfo < 2.0) {
        showInfo(currentScene.infoText);
      } else {
        hideInfo();
      }

      // Аудио-триггер
      if (pos.distanceTo(currentScene.audioTriggerPos) < currentScene.audioTriggerRadius) {
        startAmbientTone();
      } else {
        stopAmbientTone();
      }

      // Портал
      const t = performance.now() * 0.002;
      currentScene.portal.material.emissiveIntensity = 0.6 + Math.sin(t) * 0.4;
      currentScene.portal.rotation.y += 0.01;

      renderer.render(currentScene.scene, camera);
    }
    animate();

    // Обработка изменения размера
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Проверка направления взгляда
    function checkCenterLook() {
      if (!controls.isLocked) {
        setTimeout(checkCenterLook, 100);
        return;
      }
      raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
      const hits = raycaster.intersectObject(currentScene.portal);
      const hud = document.getElementById('hud');
      if (hits.length) {
        hud.innerHTML = 'Портал — нажмите мышь, чтобы активировать переход.';
      } else {
        hud.innerHTML = 'Подойдите к <b>i</b> чтобы увидеть инфо; к порталу — чтобы перейти.';
      }
      setTimeout(checkCenterLook, 100);
    }
    checkCenterLook();
  </script>
</body>
</html>
